# A/B Test 架构

## 🎯 方案概述

```
┌──────────────────┐      ┌──────────────────┐
│   主站           │      │   测试站          │
│   lovexai.studio │      │   beta.lovexai   │
│                  │      │   .studio        │
│   Vercel 部署    │      │   自建 VPS       │
│   ✅ 现有用户    │      │   ✅ 新功能测试  │
│   ✅ 稳定运行    │      │   ✅ 性能对比    │
└──────────────────┘      └──────────────────┘
          │                         │
          └─────────┬───────────────┘
                    ▼
         共享外部服务
    • Convex (数据库)
    • Stripe (支付)
    • Tu-zi AI (AI)
    • R2 (存储)
```

## ✅ 优势

| 优势 | 说明 |
|------|------|
| **零风险** | 不影响主站 |
| **真实验证** | 性能、成本对比 |
| **灵活切换** | 成功后 5 分钟 DNS 切换 |
| **渐进迁移** | 可从小流量开始 |

## 📋 实施步骤

### 阶段 1: 准备（1-2h）

```bash
# 1. 准备测试域名
beta.lovexai.studio

# 2. 准备服务器（已安装 Docker）
```

### 阶段 2: 部署（2-3h）

| 步骤 | 操作 | 关键点 |
|------|------|--------|
| 克隆代码 | `git clone` | - |
| 配置环境 | 修改 `NEXTAUTH_URL` 等 | 域名相关变量 |
| 启动 Docker | `docker-compose up -d` | - |
| 配置 Nginx | 反向代理 + SSL | - |
| 配置 DNS | 测试域名 → VPS IP | - |

### 阶段 3: 共享服务配置（1h）

由于共享外部服务，需要配置两套 Webhook：

```
Stripe:
  主站: https://lovexai.studio/api/stripe-notify
  测试站: https://beta.lovexai.studio/api/stripe-notify
```

### 阶段 4: 测试验证（持续）

```
功能测试
□ 用户注册/登录
□ 角色聊天
□ 积分系统
□ 支付流程（小额测试）
□ 图片上传

性能监控
□ 响应时间对比
□ 并发能力对比
□ 资源占用
□ 错误率统计
```

## ⚠️ 注意事项

### 环境变量差异

```bash
# 主站
NEXTAUTH_URL=https://lovexai.studio
NEXT_PUBLIC_WEB_URL=https://lovexai.studio

# 测试站
NEXTAUTH_URL=https://beta.lovexai.studio
NEXT_PUBLIC_WEB_URL=https://beta.lovexai.studio

# 相同的变量
NEXT_PUBLIC_CONVEX_URL=...
STRIPE_PRIVATE_KEY=...
```

### Session 不共享

```
用户在主站登录
    ↓
跳转到测试站
    ↓
需要重新登录 ❌

# 解决方案：
- 使用统一域名 + 共享 Cookie（复杂）
- 接受测试站独立登录（推荐）
```

## 📊 对比指标

| 指标 | Vercel 主站 | VPS 测试站 |
|------|-------------|------------|
| 首屏加载 | ___ ms | ___ ms |
| API 响应 | ___ ms | ___ ms |
| 月费用 | $___ | $___ |
| Uptime | 99.9% | ___% |
| 并发能力 | ___ req/s | ___ req/s |

## 🎯 决策矩阵

| 触发条件 | 紧急度 | 迁移方式 |
|----------|--------|----------|
| Vercel 警告邮件 | ⭐⭐⭐⭐ | 24h 内迁移 |
| 流量激增 | ⭐⭐⭐ | 提前 1 周 |
| 需要 NSFW 功能 | ⭐⭐⭐⭐⭐ | 功能上线时迁移 |
| 想要更多控制 | ⭐⭐ | 择机迁移 |

## 💰 成本对比

```
Vercel: $20-40/月（流量大时激增）
VPS: $5-15/月（固定费用）

节省约 $25/月
```

## 🎯 总结

- **复杂度**: ⭐⭐ (较低)
- **风险**: ⭐ (极低)
- **收益**: ⭐⭐⭐⭐⭐ (很高)
- **实施时间**: 3-5 天

**核心建议**: 做一次 POC (2-3 天)，验证可行性后再全面部署。
